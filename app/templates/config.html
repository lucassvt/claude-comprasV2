<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuracion - Sistema de Compras</title>
    <link rel="icon" type="image/png" href="/imagenes/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #0066CC;
            --primary-dark: #004C99;
            --primary-light: #3399FF;
            --accent-orange: #FF6B35;
            --bg-light: #F8FAFC;
            --bg-white: #FFFFFF;
            --text-dark: #1E293B;
            --text-gray: #64748B;
            --text-light: #94A3B8;
            --border-color: #E2E8F0;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', 'Segoe UI', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 0;
            box-shadow: 0 4px 20px rgba(0, 102, 204, 0.3);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 30px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-section img {
            height: 60px;
        }

        .logo-text {
            display: flex;
            flex-direction: column;
        }

        .logo-text h1 {
            font-size: 1.3em;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .logo-text .subtitle {
            font-size: 0.75em;
            opacity: 0.9;
            font-weight: 300;
        }

        nav {
            display: flex;
            gap: 5px;
        }

        nav a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        nav a:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        nav a.active {
            background: rgba(255, 255, 255, 0.2);
        }

        nav a svg {
            width: 18px;
            height: 18px;
        }

        /* Main Content */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px;
            flex: 1;
        }

        .section {
            background: var(--bg-white);
            border-radius: 16px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05), 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }

        .section-title {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--primary-blue);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--primary-light);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title svg {
            width: 22px;
            height: 22px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.9em;
        }

        .form-group input[type="number"],
        .form-group select {
            width: 100%;
            max-width: 220px;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1em;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .form-group input[type="number"]:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            font-family: inherit;
        }

        .btn svg {
            width: 18px;
            height: 18px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 102, 204, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #DC2626);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--text-gray), #475569);
            color: white;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.85em;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.9em;
        }

        tr:hover {
            background-color: #f8fafc;
        }

        /* Add Row */
        .add-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 12px;
            flex-wrap: wrap;
        }

        .add-row .form-group {
            margin-bottom: 0;
            flex: 1;
            min-width: 150px;
        }

        /* Checkbox List */
        .checkbox-list {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s ease;
        }

        .checkbox-item:last-child {
            border-bottom: none;
        }

        .checkbox-item:hover {
            background: #f8fafc;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
            accent-color: var(--primary-blue);
        }

        .checkbox-item label {
            cursor: pointer;
            flex: 1;
            font-weight: 500;
        }

        /* Messages */
        .message {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
            font-weight: 500;
        }

        .message.success {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            color: #166534;
            border: 1px solid #86efac;
        }

        .message.error {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .message.active {
            display: block;
        }

        /* Columns */
        .columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .columns h4 {
            margin-bottom: 12px;
            color: var(--text-dark);
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .columns {
                grid-template-columns: 1fr;
            }

            .header-content {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }

            nav {
                width: 100%;
                justify-content: center;
            }

            .container {
                padding: 15px;
            }
        }

        /* Footer */
        footer {
            background: linear-gradient(135deg, var(--text-dark), #0f172a);
            color: white;
            text-align: center;
            padding: 30px 20px;
            margin-top: auto;
        }

        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
        }

        .footer-main {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .footer-main img {
            height: 40px;
        }

        .footer-text {
            font-size: 0.95em;
            font-weight: 500;
        }

        .footer-developer {
            font-size: 0.85em;
            color: var(--text-light);
            margin-top: 10px;
        }

        .footer-quote {
            margin-top: 20px;
            font-size: 0.9em;
            font-style: italic;
            background: linear-gradient(90deg, #60a5fa, #a78bfa, #f472b6, #60a5fa);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradient-shift 4s ease infinite;
            font-weight: 500;
        }

        @keyframes gradient-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .description {
            font-size: 0.9em;
            color: var(--text-gray);
            margin-bottom: 15px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 15px;
        }

        .loading.active {
            display: block;
        }

        /* Badge/Tag for category type */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
        }
        .badge-marca { background: #dbeafe; color: #1d4ed8; }
        .badge-rubro { background: #dcfce7; color: #166534; }
        .badge-subrubro { background: #fef3c7; color: #92400e; }

        /* Subsection styling */
        .subsection {
            background: #f8fafc;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        .subsection-title {
            font-size: 1em;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 15px;
        }

        /* Info box */
        .info-box {
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            border: 1px solid #93c5fd;
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 20px;
        }
        .info-box strong {
            color: var(--primary-dark);
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo-section">
                <img src="/imagenes/logo%20La%20Mascotera%20(1).png" alt="La Mascotera">
                <div class="logo-text">
                    <h1>CONFIGURACION</h1>
                    <span class="subtitle">Sistema de Compras v2.0</span>
                </div>
            </div>
            <nav>
                <a href="/">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    Dashboard
                </a>
                <a href="/config" class="active">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    Configuracion
                </a>
            </nav>
        </div>
    </header>

    <div class="container">
        <!-- Panel 1: Parametros de Calculo -->
        <section class="section">
            <h2 class="section-title">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
                </svg>
                Parametros de Calculo
            </h2>

            <!-- Valores globales por defecto -->
            <div class="info-box">
                <strong>Valores por defecto:</strong> Se aplican a todos los productos que no tienen una excepcion configurada.
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="diasStockDefault">Dias de stock minimo</label>
                    <input type="number" id="diasStockDefault" min="1" max="365" value="14">
                </div>
                <div class="form-group">
                    <label for="factorIdeal">Factor stock ideal (x minimo)</label>
                    <input type="number" id="factorIdeal" min="1" max="10" step="0.1" value="2.0">
                </div>
                <div class="form-group">
                    <label for="factorMaximo">Factor stock maximo (x minimo)</label>
                    <input type="number" id="factorMaximo" min="1" max="20" step="0.1" value="4.0">
                </div>
                <div class="form-group">
                    <label for="periodoVentas">Periodo de ventas (dias)</label>
                    <input type="number" id="periodoVentas" min="30" max="730" value="365">
                </div>
            </div>
            <button class="btn btn-success" onclick="saveGlobalParams()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Guardar Parametros Globales
            </button>
            <div class="message" id="messageGlobal"></div>

            <!-- Excepciones por marca/rubro/subrubro -->
            <div class="subsection">
                <h3 class="subsection-title">Excepciones por Marca / Rubro / Subrubro</h3>
                <p class="description">
                    Configure valores diferentes para categorias especificas. <strong>Prioridad:</strong> Marca > Subrubro > Rubro > Global
                </p>

                <table id="tableParams">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Nombre</th>
                            <th>Dias Stock</th>
                            <th>Factor Ideal</th>
                            <th>Factor Maximo</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="paramsTableBody">
                    </tbody>
                </table>

                <div class="add-row">
                    <div class="form-group">
                        <label for="paramTipo">Tipo</label>
                        <select id="paramTipo" onchange="updateParamOptions()">
                            <option value="">Seleccione...</option>
                            <option value="marca">Marca</option>
                            <option value="rubro">Rubro</option>
                            <option value="subrubro">Subrubro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="paramNombre">Nombre</label>
                        <select id="paramNombre">
                            <option value="">Seleccione tipo primero...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="paramDias">Dias Stock</label>
                        <input type="number" id="paramDias" min="1" max="365" value="14">
                    </div>
                    <div class="form-group">
                        <label for="paramFactorIdeal">Factor Ideal</label>
                        <input type="number" id="paramFactorIdeal" min="1" max="10" step="0.1" value="2.0">
                    </div>
                    <div class="form-group">
                        <label for="paramFactorMax">Factor Max</label>
                        <input type="number" id="paramFactorMax" min="1" max="20" step="0.1" value="4.0">
                    </div>
                    <button class="btn btn-primary" onclick="addCategoryParams()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                        Agregar
                    </button>
                </div>
                <div class="message" id="messageParams"></div>
            </div>
        </section>

        <!-- Panel 2: Umbral Minimo de Ventas -->
        <section class="section">
            <h2 class="section-title">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                Umbral Minimo de Ventas
            </h2>

            <div class="info-box">
                <strong>Umbral por defecto:</strong> Productos con ventas menores al umbral (en el periodo de ventas) no se reponen automaticamente.
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="umbralGlobal">Umbral minimo global (ventas)</label>
                    <input type="number" id="umbralGlobal" min="1" max="1000" value="5">
                    <small style="color: #666; font-size: 11px;">Ventas minimas para calcular stock min/ideal/max</small>
                </div>
            </div>
            <button class="btn btn-success" onclick="saveGlobalThreshold()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Guardar Umbral Global
            </button>
            <div class="message" id="messageUmbralGlobal"></div>

            <!-- Excepciones de umbral por marca/rubro/subrubro -->
            <div class="subsection">
                <h3 class="subsection-title">Excepciones de Umbral por Marca / Rubro / Subrubro</h3>
                <p class="description">
                    Configure umbrales diferentes para categorias especificas. <strong>Prioridad:</strong> Marca > Subrubro > Rubro > Global
                </p>

                <table id="tableThresholds">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Nombre</th>
                            <th>Umbral (ventas)</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="thresholdsTableBody">
                    </tbody>
                </table>

                <div class="add-row">
                    <div class="form-group">
                        <label for="thresholdTipo">Tipo</label>
                        <select id="thresholdTipo" onchange="updateThresholdOptions()">
                            <option value="">Seleccione...</option>
                            <option value="marca">Marca</option>
                            <option value="rubro">Rubro</option>
                            <option value="subrubro">Subrubro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="thresholdNombre">Nombre</label>
                        <select id="thresholdNombre">
                            <option value="">Seleccione tipo primero...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="thresholdUmbral">Umbral (ventas)</label>
                        <input type="number" id="thresholdUmbral" min="1" max="1000" value="5">
                    </div>
                    <button class="btn btn-primary" onclick="addThreshold()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                        Agregar
                    </button>
                </div>
                <div class="message" id="messageThresholds"></div>
            </div>
        </section>

        <!-- Metodo de Calculo de Demanda -->
        <section class="section">
            <h2 class="section-title">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                </svg>
                Metodo de Calculo de Demanda
            </h2>
            <p class="description">
                Define como se calcula la demanda diaria de cada producto para determinar los niveles de stock.
                <br><br>
                <strong>Metodo actual:</strong> <span id="currentDemandMethod" style="color: var(--primary-blue); font-weight: bold;">Cargando...</span>
            </p>

            <div class="method-selector" style="display: flex; flex-direction: column; gap: 15px; margin-top: 20px;">
                <label class="method-option" style="display: flex; align-items: flex-start; gap: 10px; padding: 15px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer;">
                    <input type="radio" name="demandMethod" value="mediana" style="margin-top: 4px;">
                    <div>
                        <strong style="color: var(--success);">Mediana Ajustada (Recomendado)</strong>
                        <p style="margin: 5px 0 0 0; font-size: 13px; color: #888;">
                            Usa la mediana de ventas diarias ajustada por proporcion de dias con ventas.
                            <br><strong>Robusto a picos y outliers.</strong> Ideal para productos con ventas irregulares.
                        </p>
                    </div>
                </label>

                <label class="method-option" style="display: flex; align-items: flex-start; gap: 10px; padding: 15px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer;">
                    <input type="radio" name="demandMethod" value="promedio_simple" style="margin-top: 4px;">
                    <div>
                        <strong>Promedio Simple</strong>
                        <p style="margin: 5px 0 0 0; font-size: 13px; color: #888;">
                            Calcula ventas_totales / dias_periodo.
                            <br>Sensible a picos de ventas atipicos (un dia con muchas ventas distorsiona el calculo).
                        </p>
                    </div>
                </label>

                <label class="method-option" style="display: flex; align-items: flex-start; gap: 10px; padding: 15px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer;">
                    <input type="radio" name="demandMethod" value="combinado" style="margin-top: 4px;">
                    <div>
                        <strong>Combinado (ML + Movil)</strong>
                        <p style="margin: 5px 0 0 0; font-size: 13px; color: #888;">
                            Combina promedio movil ponderado y Machine Learning con deteccion de tendencia.
                            <br>Requiere mas datos historicos para funcionar correctamente.
                        </p>
                    </div>
                </label>
            </div>

            <button class="btn btn-primary" onclick="saveDemandMethod()" style="margin-top: 20px;">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Guardar Metodo de Calculo
            </button>
            <div class="message" id="messageDemandMethod"></div>

            <p class="description" style="margin-top: 20px; padding: 10px; background: rgba(255,193,7,0.1); border-radius: 5px;">
                <strong>Nota:</strong> El cambio de metodo se aplica en el proximo recalculo de stock.
                Para ver los cambios, ejecute "Recalcular Stock" desde el Dashboard.
            </p>
        </section>

        <!-- Exclusiones -->
        <section class="section">
            <h2 class="section-title">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>
                </svg>
                Exclusiones
            </h2>
            <p class="description">
                Seleccione los depositos y marcas que desea excluir del analisis y las propuestas.
            </p>

            <div class="columns">
                <div>
                    <h4>Depositos Excluidos</h4>
                    <div class="checkbox-list" id="depositsList">
                    </div>
                </div>
                <div>
                    <h4>Marcas Excluidas</h4>
                    <div class="checkbox-list" id="brandsList">
                    </div>
                </div>
            </div>

            <button class="btn btn-success" onclick="saveExclusions()" style="margin-top: 20px;">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Guardar Exclusiones
            </button>
            <div class="message" id="messageExclusions"></div>
        </section>
    </div>

    <footer>
        <div class="footer-content">
            <div class="footer-main">
                <img src="/imagenes/corazon%20azul.png" alt="Corazon La Mascotera">
                <span class="footer-text">LA MASCOTERA SAS</span>
            </div>
            <div class="footer-developer">
                Desarrollado por Lucas Salvatierra Software
            </div>
            <div class="footer-quote">
                "Ad astra per aspera"
            </div>
        </div>
    </footer>

    <script>
        // Datos globales para los selects
        let availableMarcas = [];
        let availableRubros = [];
        let availableSubrubros = [];

        // Cargar configuracion al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            loadCategoryParams();
            loadThresholds();
        });

        // Cargar toda la configuracion
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const data = await response.json();

                // Parametros globales
                document.getElementById('diasStockDefault').value = data.global_params.dias_stock_default;
                document.getElementById('factorIdeal').value = data.global_params.factor_ideal;
                document.getElementById('factorMaximo').value = data.global_params.factor_maximo;
                document.getElementById('periodoVentas').value = data.global_params.periodo_ventas_dias;
                document.getElementById('umbralGlobal').value = data.global_params.umbral_minimo_ventas || 5;

                // Guardar listas para selects
                availableMarcas = data.available_brands || [];
                availableRubros = data.available_rubros || [];
                availableSubrubros = data.available_subrubros || [];

                // Listas de exclusion
                loadDepositCheckboxes(data.available_deposits, data.excluded_deposits);
                loadBrandCheckboxes(data.available_brands, data.excluded_brands);

                // Metodo de calculo de demanda
                loadDemandMethod();

            } catch (error) {
                console.error('Error cargando configuracion:', error);
            }
        }

        // Cargar parametros por categoria
        async function loadCategoryParams() {
            try {
                const response = await fetch('/api/config/category-params');
                const data = await response.json();

                if (data.status === 'ok') {
                    renderParamsTable(data.params);
                }
            } catch (error) {
                console.error('Error cargando parametros por categoria:', error);
            }
        }

        // Cargar umbrales por categoria
        async function loadThresholds() {
            try {
                const response = await fetch('/api/config/thresholds');
                const data = await response.json();

                if (data.status === 'ok') {
                    renderThresholdsTable(data.thresholds);
                }
            } catch (error) {
                console.error('Error cargando umbrales:', error);
            }
        }

        // Renderizar tabla de parametros
        function renderParamsTable(params) {
            const tbody = document.getElementById('paramsTableBody');
            tbody.innerHTML = '';

            let hasData = false;

            // Procesar cada tipo
            for (const tipo of ['marca', 'rubro', 'subrubro']) {
                const items = params[tipo] || {};
                for (const [nombre, values] of Object.entries(items)) {
                    hasData = true;
                    const tr = document.createElement('tr');
                    const badgeClass = `badge-${tipo}`;
                    const safeNombre = nombre.replace(/'/g, "\\'");
                    tr.innerHTML = `
                        <td><span class="badge ${badgeClass}">${tipo}</span></td>
                        <td>${nombre}</td>
                        <td>${values.dias_stock || '-'}</td>
                        <td>${values.factor_ideal || 'global'}</td>
                        <td>${values.factor_maximo || 'global'}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="deleteCategoryParams('${tipo}', '${safeNombre}')">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                                Eliminar
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                }
            }

            if (!hasData) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-gray);">No hay excepciones configuradas (todos usan valores globales)</td></tr>';
            }
        }

        // Renderizar tabla de umbrales
        function renderThresholdsTable(thresholds) {
            const tbody = document.getElementById('thresholdsTableBody');
            tbody.innerHTML = '';

            let hasData = false;

            for (const tipo of ['marca', 'rubro', 'subrubro']) {
                const items = thresholds[tipo] || {};
                for (const [nombre, umbral] of Object.entries(items)) {
                    hasData = true;
                    const tr = document.createElement('tr');
                    const badgeClass = `badge-${tipo}`;
                    const safeNombre = nombre.replace(/'/g, "\\'");
                    tr.innerHTML = `
                        <td><span class="badge ${badgeClass}">${tipo}</span></td>
                        <td>${nombre}</td>
                        <td>${umbral} ventas</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="deleteThreshold('${tipo}', '${safeNombre}')">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                                Eliminar
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                }
            }

            if (!hasData) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-gray);">No hay excepciones configuradas (todos usan umbral global)</td></tr>';
            }
        }

        // Actualizar opciones del select de parametros
        function updateParamOptions() {
            const tipo = document.getElementById('paramTipo').value;
            const select = document.getElementById('paramNombre');
            select.innerHTML = '<option value="">Seleccione...</option>';

            let options = [];
            if (tipo === 'marca') options = availableMarcas;
            else if (tipo === 'rubro') options = availableRubros;
            else if (tipo === 'subrubro') options = availableSubrubros;

            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                select.appendChild(option);
            });
        }

        // Actualizar opciones del select de umbrales
        function updateThresholdOptions() {
            const tipo = document.getElementById('thresholdTipo').value;
            const select = document.getElementById('thresholdNombre');
            select.innerHTML = '<option value="">Seleccione...</option>';

            let options = [];
            if (tipo === 'marca') options = availableMarcas;
            else if (tipo === 'rubro') options = availableRubros;
            else if (tipo === 'subrubro') options = availableSubrubros;

            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                select.appendChild(option);
            });
        }

        // Guardar parametros globales
        async function saveGlobalParams() {
            const message = document.getElementById('messageGlobal');
            message.classList.remove('active', 'success', 'error');

            const params = {
                dias_stock_default: parseInt(document.getElementById('diasStockDefault').value),
                factor_ideal: parseFloat(document.getElementById('factorIdeal').value),
                factor_maximo: parseFloat(document.getElementById('factorMaximo').value),
                periodo_ventas_dias: parseInt(document.getElementById('periodoVentas').value),
                umbral_minimo_ventas: parseInt(document.getElementById('umbralGlobal').value)
            };

            try {
                const response = await fetch('/api/config/global-params', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });

                if (response.ok) {
                    message.textContent = 'Parametros globales guardados correctamente';
                    message.classList.add('active', 'success');
                } else {
                    throw new Error('Error al guardar');
                }
            } catch (error) {
                message.textContent = 'Error: ' + error.message;
                message.classList.add('active', 'error');
            }
        }

        // Guardar umbral global
        async function saveGlobalThreshold() {
            const message = document.getElementById('messageUmbralGlobal');
            message.classList.remove('active', 'success', 'error');

            const umbral = parseInt(document.getElementById('umbralGlobal').value);

            const params = {
                dias_stock_default: parseInt(document.getElementById('diasStockDefault').value),
                factor_ideal: parseFloat(document.getElementById('factorIdeal').value),
                factor_maximo: parseFloat(document.getElementById('factorMaximo').value),
                periodo_ventas_dias: parseInt(document.getElementById('periodoVentas').value),
                umbral_minimo_ventas: umbral
            };

            try {
                const response = await fetch('/api/config/global-params', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });

                if (response.ok) {
                    message.textContent = 'Umbral global guardado correctamente';
                    message.classList.add('active', 'success');
                } else {
                    throw new Error('Error al guardar');
                }
            } catch (error) {
                message.textContent = 'Error: ' + error.message;
                message.classList.add('active', 'error');
            }
        }

        // Agregar parametros por categoria
        async function addCategoryParams() {
            const message = document.getElementById('messageParams');
            message.classList.remove('active', 'success', 'error');

            const tipo = document.getElementById('paramTipo').value;
            const nombre = document.getElementById('paramNombre').value;
            const dias = parseInt(document.getElementById('paramDias').value);
            const factorIdeal = parseFloat(document.getElementById('paramFactorIdeal').value);
            const factorMax = parseFloat(document.getElementById('paramFactorMax').value);

            if (!tipo || !nombre) {
                message.textContent = 'Seleccione tipo y nombre';
                message.classList.add('active', 'error');
                return;
            }

            try {
                const response = await fetch('/api/config/category-params', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tipo,
                        nombre,
                        dias_stock: dias,
                        factor_ideal: factorIdeal,
                        factor_maximo: factorMax
                    })
                });

                if (response.ok) {
                    message.textContent = 'Excepcion agregada correctamente';
                    message.classList.add('active', 'success');
                    loadCategoryParams();
                    // Limpiar selects
                    document.getElementById('paramTipo').value = '';
                    document.getElementById('paramNombre').innerHTML = '<option value="">Seleccione tipo primero...</option>';
                } else {
                    throw new Error('Error al guardar');
                }
            } catch (error) {
                message.textContent = 'Error: ' + error.message;
                message.classList.add('active', 'error');
            }
        }

        // Eliminar parametros por categoria
        async function deleteCategoryParams(tipo, nombre) {
            if (!confirm(`Eliminar excepcion de ${tipo} "${nombre}"?`)) return;

            try {
                const response = await fetch(`/api/config/category-params/${tipo}/${encodeURIComponent(nombre)}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadCategoryParams();
                }
            } catch (error) {
                console.error('Error eliminando:', error);
            }
        }

        // Agregar umbral por categoria
        async function addThreshold() {
            const message = document.getElementById('messageThresholds');
            message.classList.remove('active', 'success', 'error');

            const tipo = document.getElementById('thresholdTipo').value;
            const nombre = document.getElementById('thresholdNombre').value;
            const umbral = parseInt(document.getElementById('thresholdUmbral').value);

            if (!tipo || !nombre) {
                message.textContent = 'Seleccione tipo y nombre';
                message.classList.add('active', 'error');
                return;
            }

            try {
                const response = await fetch('/api/config/threshold', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tipo, nombre, umbral })
                });

                if (response.ok) {
                    message.textContent = 'Umbral agregado correctamente';
                    message.classList.add('active', 'success');
                    loadThresholds();
                    document.getElementById('thresholdTipo').value = '';
                    document.getElementById('thresholdNombre').innerHTML = '<option value="">Seleccione tipo primero...</option>';
                } else {
                    throw new Error('Error al guardar');
                }
            } catch (error) {
                message.textContent = 'Error: ' + error.message;
                message.classList.add('active', 'error');
            }
        }

        // Eliminar umbral por categoria
        async function deleteThreshold(tipo, nombre) {
            if (!confirm(`Eliminar umbral de ${tipo} "${nombre}"?`)) return;

            try {
                const response = await fetch(`/api/config/threshold/${tipo}/${encodeURIComponent(nombre)}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadThresholds();
                }
            } catch (error) {
                console.error('Error eliminando:', error);
            }
        }

        // Cargar metodo de calculo de demanda
        async function loadDemandMethod() {
            try {
                const response = await fetch('/api/config/demand-method');
                const data = await response.json();

                if (data.status === 'ok') {
                    const metodo = data.metodo_actual;

                    const nombres = {
                        'promedio_simple': 'Promedio Simple',
                        'mediana': 'Mediana Ajustada',
                        'combinado': 'Combinado (ML + Movil)'
                    };
                    document.getElementById('currentDemandMethod').textContent = nombres[metodo] || metodo;

                    const radio = document.querySelector(`input[name="demandMethod"][value="${metodo}"]`);
                    if (radio) {
                        radio.checked = true;
                    }
                }
            } catch (error) {
                console.error('Error cargando metodo de demanda:', error);
            }
        }

        // Guardar metodo de calculo de demanda
        async function saveDemandMethod() {
            const message = document.getElementById('messageDemandMethod');
            message.classList.remove('active', 'success', 'error');

            const selectedRadio = document.querySelector('input[name="demandMethod"]:checked');
            if (!selectedRadio) {
                message.textContent = 'Seleccione un metodo de calculo';
                message.classList.add('active', 'error');
                return;
            }

            const metodo = selectedRadio.value;

            try {
                const response = await fetch('/api/config/demand-method', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ metodo })
                });

                const data = await response.json();

                if (response.ok) {
                    message.textContent = data.message || 'Metodo guardado correctamente';
                    message.classList.add('active', 'success');
                    loadDemandMethod();
                } else {
                    throw new Error(data.detail || 'Error al guardar');
                }
            } catch (error) {
                message.textContent = 'Error: ' + error.message;
                message.classList.add('active', 'error');
            }
        }

        // Cargar checkboxes de depositos
        function loadDepositCheckboxes(deposits, excluded) {
            const container = document.getElementById('depositsList');
            container.innerHTML = '';

            deposits.forEach(dep => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                const isExcluded = excluded.includes(dep.nombre);
                div.innerHTML = `
                    <input type="checkbox" id="dep_${dep.id}" value="${dep.nombre}"
                        ${isExcluded ? 'checked' : ''}>
                    <label for="dep_${dep.id}">${dep.nombre} ${dep.es_central ? '(Central)' : ''}</label>
                `;
                container.appendChild(div);
            });
        }

        // Cargar checkboxes de marcas
        function loadBrandCheckboxes(brands, excluded) {
            const container = document.getElementById('brandsList');
            container.innerHTML = '';

            brands.forEach(brand => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                const isExcluded = excluded.includes(brand);
                const safeBrand = brand.replace(/'/g, "\\'");
                div.innerHTML = `
                    <input type="checkbox" id="brand_${brand}" value="${safeBrand}"
                        ${isExcluded ? 'checked' : ''}>
                    <label for="brand_${brand}">${brand}</label>
                `;
                container.appendChild(div);
            });
        }

        // Guardar exclusiones
        async function saveExclusions() {
            const message = document.getElementById('messageExclusions');
            message.classList.remove('active', 'success', 'error');

            const depositCheckboxes = document.querySelectorAll('#depositsList input[type="checkbox"]:checked');
            const excluded_deposits = Array.from(depositCheckboxes).map(cb => cb.value);

            const brandCheckboxes = document.querySelectorAll('#brandsList input[type="checkbox"]:checked');
            const excluded_brands = Array.from(brandCheckboxes).map(cb => cb.value);

            try {
                const response = await fetch('/api/config/exclusions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ excluded_deposits, excluded_brands })
                });

                if (response.ok) {
                    message.textContent = 'Exclusiones guardadas correctamente';
                    message.classList.add('active', 'success');
                } else {
                    throw new Error('Error al guardar');
                }
            } catch (error) {
                message.textContent = 'Error: ' + error.message;
                message.classList.add('active', 'error');
            }
        }
    </script>
</body>
</html>
